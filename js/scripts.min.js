// @codekit-append 'popouts.js', 'addons.js', 'background.js', 'clock.js', 'search.js', 'countdown.js';

$(function() {
	$(document).click(function() {
		popout();
	});

	$('.popout').click(function(e) {
		e.stopPropagation();
	});

	function popout(name) {
		if(name != undefined) {
			var pop = $('#' + name);

			$('.popout').not(document.getElementById(name)).removeClass('active');

			if(pop.hasClass('active')) {
				pop.removeClass('active');
			} else {
				pop.addClass('active');
			}
		} else {
			$('.popout').removeClass('active');
		}
	}

	var hovering = false;
	var customwallpaper;
	var search;
	var countdowntimer;

	$(document).mousemove(function() {
		$('.menu').addClass('active');

		lastTimeMouseMoved = new Date().getTime();
		var t = setTimeout(function() {
			var currentTime = new Date().getTime();
			if(!hovering && !$('.popout').hasClass('active')) {
				if(currentTime - lastTimeMouseMoved > 1000) {
					$('.menu').removeClass('active');
				}
			}
	   }, 1000);
	});

	$('.icon').hover(function() {
	    hovering = true;
	}, function() {
	    hovering = false;
	});

	$('.icon').click(function(e) {
		e.stopPropagation();
	});

	$('#btn-addons').click(function(e) {
		popout('addons');
		e.preventDefault();
	});

	$('#btn-about').click(function(e) {
		popout('about');
		e.preventDefault();
	});

	$('#add-customwallpaper').click(function(e) {
		if(customwallpaper === 0) {
			localStorage.setItem('customwallpaper', 1);
		} else {
			localStorage.setItem('customwallpaper', 0);
		}

		customWallpaper();

		e.preventDefault();
	});

	function customWallpaper() {
		if(localStorage.getItem('customwallpaper') == 1) {
			customwallpaper = 1;

			$('#btn-customwallpaper').show();
			$('#add-customwallpaper img').attr('src', 'img/check.svg');
		} else {
			customwallpaper = 0;

			$('#btn-customwallpaper').hide();
			$('#add-customwallpaper img').attr('src', 'img/uncheck.svg');
		}
	}
	customWallpaper();

	$('#add-search').click(function(e) {
		if(search === 0) {
			localStorage.setItem('search', 1);
		} else {
			localStorage.setItem('search', 0);
		}

		getSearch();

		e.preventDefault();
	});

	function getSearch() {
		if(localStorage.getItem('search') == 1) {
			search = 1;

			$('.search').fadeIn();
			$('#add-search img').attr('src', 'img/check.svg');
			$('#query').focus();
		} else {
			search = 0;

			$('.search').fadeOut();
			$('#add-search img').attr('src', 'img/uncheck.svg');
		}
	}
	getSearch();

	$('#add-countdowntimer').click(function(e) {
		if(countdowntimer === 0) {
			localStorage.setItem('countdowntimer', 1);
		} else {
			localStorage.setItem('countdowntimer', 0);
		}

		getCountdown();

		e.preventDefault();
	});

	function getCountdown() {
		if(localStorage.getItem('countdowntimer') == 1) {
			countdowntimer = 1;

			$('#btn-countdowntimer').show();
			$('#add-countdowntimer img').attr('src', 'img/check.svg');
		} else {
			countdowntimer = 0;

			$('#btn-countdowntimer').hide();
			$('#add-countdowntimer img').attr('src', 'img/uncheck.svg');
		}
	}
	getCountdown();

	var date = new Date();
	date = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();

	function getWallpaper() {
		if(localStorage.getItem('customwallpaper') == 1 && localStorage.getItem('customwallpaperurl') != null && localStorage.getItem('customwallpaperurl') != '') {
			$('body').css('background-image', 'url(' + localStorage.getItem('customwallpaperurl') + ')');
			$('#input-customwallpaper').val(localStorage.getItem('customwallpaperurl'));
		} else {
			var imageData;

			if(localStorage.getItem(date) === null) {
				localStorage.removeItem(date);

				var img = new Image();
				img.crossOrigin = '';
				var random = Math.random() * 10000;
				img.src = 'https://unsplash.it/1920/1080/?random&element=body&version=' + random;

				img.onload = function() {
					var canvas = document.createElement('canvas');
					canvas.width = 1920;
					canvas.height = 1080;
					document.body.appendChild(canvas);
					var context = canvas.getContext('2d');
					context.drawImage(img, 0, 0);

					imageData = canvas.toDataURL("image/jpeg");

					localStorage.setItem(date, imageData);
					$('body').css('background-image', 'url(' + imageData + ')');
					$('#btn-refresh').delay(1000).removeClass('rotating');
				};
			} else {
				imageData = localStorage.getItem(date);
				$('body').css('background-image', 'url(' + imageData + ')');
			}
		}
	}
	getWallpaper();

	$('#btn-refresh').click(function(e) {
		localStorage.setItem('customwallpaper', 0);
		customwallpaper = 0;
		localStorage.removeItem(date);

		$(this).addClass('rotating');

		getWallpaper();
		e.preventDefault();
	});

	$('#btn-customwallpaper').click(function(e) {
		popout('customwallpaper');
		$('#input-customwallpaper').focus();

		e.preventDefault();
	});

	$('#input-customwallpaper').keypress(function(e) {
		if(e.keyCode == 13) {
			localStorage.setItem('customwallpaperurl', $(this).val());
			getWallpaper();
			popover();
		}
	});

	var military;
	if(localStorage.getItem('military') == 1) {
		military = 1;
	} else {
		military = 0;
	}

	function clock() {
		if(counter === null) {
			var now = new Date();
			var hh = now.getHours();
			var min = now.getMinutes();

			if(military === 0) {
				hh = hh % 12;
				hh = hh ? hh : 12;
				hh = hh === 0?'0'+hh:hh;
			} else {
				if(hh > 12) {
					hh = hh % 24;
					hh = hh < 9 ? '0' + hh : hh;
				}
			}
			min = min < 10 ? '0' + min : min;

			var time = hh + ":" + min;

			$('.clock h1').text(time);
			$('.widget.clock').fadeIn(1000);
		}
	}
	clock();
	window.setInterval(clock, 100);

	var options = {weekday: "long", year: "numeric", month: "long", day: "numeric"};
	$('.date h2').text(new Date().toLocaleDateString('en-GB', options));
	$('.widget.date').fadeIn(1000);

	$('#btn-clock').click(function(e) {
		$('.widget.clock').stop(true, true).hide().fadeIn(500);
		if(military === 1) {
			localStorage.setItem('military', 0);
			military = 0;
		} else {
			localStorage.setItem('military', 1);
			military = 1;
		}
		clock();
		e.preventDefault();
	});

	$('#query').val = '';

	$('#query').keypress(function(e) {
		if(e.keyCode === 13) {
			window.location = getLocation($(this).val());
		}
	});

	function getLocation(query) {
		if(query === 'google') {
			return 'https://google.com';
		}

		if(query === 'facebook') {
			return 'https://www.facebook.com';
		}

		if(query === 'youtube') {
			return 'https://www.youtube.com';
		}

		if(query === 'yahoo') {
			return 'https://yahoo.com';
		}

		if(query === 'wiki' || query === 'wikipedia') {
			return 'http://wikipedia.org';
		}

		if(query === 'twitter') {
			return 'https://twitter.com';
		}

		if(query === 'bing') {
			return 'https://bing.com';
		}

		if(query === 'pinterest') {
			return 'https://www.pinterest.com'
		}

		if(query === 'reddit') {
			return 'https://www.reddit.com';
		}

		if(query === 'wordpress') {
			return 'https://wordpress.com';
		}

		if(query === 'instagram') {
			return 'https://instagram.com';
		}

		if(query === 'tumblr') {
			return 'https://www.tumblr.com';
		}

		if(query === 'paypal') {
			return 'https://www.paypal.com';
		}

		if(query === 'imgur') {
			return 'https://imgur.com';
		}

		if(query === 'apple') {
			return 'https://www.apple.com';
		}

		if(query === 'microsoft') {
			return 'https://www.microsoft.com';
		}

		if(query === 'imdb') {
			return 'https://www.imdb.com';
		}

		if(query === 'stack overflow') {
			return 'https://stackoverflow.com';
		}

		if(query === 'craigslist') {
			return 'http://craigslist.com';
		}

		if(query === 'netflix') {
			return 'https://www.netflix.com';
		}

		if(query === 'bbc') {
			return 'http://www.bbc.co.uk';
		}

		if(query === 'cnn') {
			return 'http://cnn.com';
		}

		if(query === 'dropbox') {
			return 'https://www.dropbox.com';
		}

		if(query === 'github') {
			return 'https://github.com';
		}

		if(query === 'gmail') {
			return 'http://mail.google.com';
		}

		if(query === 'flickr') {
			return 'https://www.flickr.com';
		}

		if(query === 'yelp') {
			return 'http://www.yelp.com';
		}

		if(query === 'godaddy') {
			return 'https://www.godaddy.com';
		}

		if(query === 'vimeo') {
			return 'https://vimeo.com';
		}

		if(query === 'etsy') {
			return 'https://www.etsy.com';
		}

		if(query === 'cnet') {
			return 'http://cnet.com';
		}

		if(query === 'slideshare') {
			return 'http://www.slideshare.com';
		}

		if(query === 'deviantart') {
			return 'http://www.deviantart.com';
		}

		if(query === 'forbes') {
			return 'http://www.forbes.com';
		}

		if(query === 'twitch') {
			return 'http://www.twitch.tv';
		}

		if(query === 'soundcloud') {
			return 'https://soundcloud.com';
		}

		if(query === 'quora') {
			return 'https://www.quora.com';
		}

		if(query === 'mailchimp') {
			return 'http://mailchimp.com';
		}

		if(query === '9gag') {
			return 'http://9gag.com';
		}

		if(query === 'lifehacker') {
			return 'http://www.lifehacker.com';
		}

		if(query === 'fiverr') {
			return 'https://www.fiverr.com';
		}

		if(query === 'gizmodo') {
			return 'http://www.gizmodo.com';
		}

		if(query === 'trello') {
			return 'https://trello.com';
		}

		if(query === 'evernote') {
			return 'https://evernote.com';
		}

		if(query === 'kickstarter') {
			return 'https://www.kickstarter.com';
		}

		if(query === 'outlook') {
			return 'https://outlook.com';
		}

		if(query === 'xe') {
			return 'http://www.xe.com';
		}

		else {
			var re = new RegExp(' ', 'g');
			query = query.replace(re, '+');
			return 'https://google.com/search?q=' + query;
		}
	}

	$('#btn-countdowntimer').click(function(e) {
		popout('countdown');
		$('#input-countdown').focus();

		e.preventDefault();
	})

	var count = 0;
	var counter = null;

	$('#input-countdown').keypress(function(e) {
		if(e.keyCode === 13) {
			if(!isNaN($(this).val())) {
				if($(this).val() > (24 * 60 * 60)) {
					$('#countdown .error').text('Cannot countdown over 24 hours').show();
				} else if($(this).val() < 1) {
					$('#countdown .error').text('Number must be positive').show();
				} else {
					$('#countdown .error').hide();

					count = $(this).val();
					window.clearInterval(counter);
					counter = null;
					countdown();

					$('#btn-countdowntimer').addClass('rotating');

					popout();
				}
			}
		}
	});

	function countdown() {
		counter = window.setInterval(timer, 1000);
	}

	function timer() {
		count = count - 1;

		if(count <= 0) {
			window.clearInterval(counter);

			$('.clock h1').text('00:00').addClass('flashing');

			window.setTimeout(function() {
				counter = null;
				$('.clock h1').removeClass('flashing');
				$('#btn-countdowntimer').removeClass('rotating');
			}, 5000);
			return;
		}

    	var hours = Math.floor(((count % 31536000) % 86400) / 3600);
		var minutes = Math.floor((((count % 31536000) % 86400) % 3600) / 60);
		var seconds = (((count % 31536000) % 86400) % 3600) % 60;
		if(hours < 10) {
			hours = '0' + hours;
		}
		if(minutes < 10) {
			minutes = '0' + minutes;
		}
		if(seconds < 10) {
			seconds = '0' + seconds;
		}

		if(hours === '00') {
			$('.clock h1').text(minutes + ":" + seconds);
		} else {
			$('.clock h1').text(hours + ":" + minutes + ":" + seconds);
		}
    }
});

